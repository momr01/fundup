CREATE PROCEDURE [dbo].[ListadoDineroPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT FECHA_GASTO AS FECHA, DESCRIPCION_GASTO AS DESCRIPCION, 0 AS INGRESO, IMPORTE_GASTO AS GASTO
	FROM GASTO
	WHERE FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	UNION
	SELECT FECHA_INGRESO AS FECHA, DESCRIPCION_INGRESO AS DESCRIPCION, IMPORTE_INGRESO AS INGRESO, 0 AS GASTO
	FROM INGRESO
	WHERE FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0

	UNION
		SELECT DATEADD(day,1,GETDATE()) AS FECHA, 'SUBTOTALES' AS DESCRIPCION, (
	SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i 
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)) > 0 
	
	THEN (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)
	ELSE 0
	END
	AS INGRESO), 
	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		 )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		))
		ELSE 0
		 END AS GASTO
	)
	UNION
	SELECT DATEADD(day,2,GETDATE()) AS FECHA, 'TOTAL' AS DESCRIPCION, (
	SELECT CASE
	WHEN (
	(SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i 
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)) > 0 
	
	THEN (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)
	ELSE 0
	END
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		
		)
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		))
		 ELSE 0
		 END
	)
	
	) > 0
		THEN (
	(SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i 
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)) > 0 
	
	THEN (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)
	ELSE 0
	END
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		 )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		
		))
		 ELSE 0
		 END
	))
		ELSE 0
	END AS INGRESO
	) AS INGRESO,  (
	SELECT CASE
	WHEN (
	(SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i 
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)) > 0 
	
	THEN (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)
	ELSE 0
	END
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		 )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
		AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		
		))
		 ELSE 0
		 END
	)) < 0
		THEN (
	(SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i 
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)) > 0 
	
	THEN (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)
	ELSE 0
	END
	
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
			AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
 )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM GASTO g 
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 0
			AND g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
		
		))
		 ELSE 0
		 END
	))
		ELSE 0
	END AS GASTO
	) AS GASTO
	
	ORDER BY FECHA ASC
END
