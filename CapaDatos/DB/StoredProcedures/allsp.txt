CREATE PROCEDURE [dbo].[AnularCategoria]
@idCategoria int
AS
BEGIN
UPDATE CATEGORIA
SET ESTA_ACTIVA_CATEGORIA = 0
WHERE ID_CATEGORIA = @idCategoria
END

CREATE PROCEDURE [dbo].[AnularGasto]
@idUsuario int,
@idDinero int
AS
BEGIN
UPDATE GASTO
SET ESTA_ACTIVO_GASTO = 0
WHERE ID_GASTO = @idDinero
AND ID_USUARIO = @idUsuario
END

CREATE PROCEDURE [dbo].[AnularIngreso]
@idUsuario int,
@idDinero int
AS
BEGIN
UPDATE INGRESO
SET ESTA_ACTIVO_INGRESO = 0
WHERE ID_INGRESO = @idDinero
AND ID_USUARIO = @idUsuario
END

CREATE PROCEDURE [dbo].[CategoriasGastos]
	@idUsuario int
AS
BEGIN
	SELECT ID_USUARIO, COUNT(DISTINCT ID_CATEGORIA) AS CATEGORIAS_USADAS
	FROM GASTO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO
END

CREATE PROCEDURE [dbo].[CategoriasIngresos]
	@idUsuario int
AS
BEGIN
	SELECT ID_USUARIO, COUNT(DISTINCT ID_CATEGORIA) AS CATEGORIAS_USADAS
	FROM INGRESO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO
END

CREATE PROCEDURE [dbo].[EditarCategoria]
	@ID_CATEGORIA int,
	@NOMBRE_CATEGORIA varchar(100),
	@DESCRIPCION_CATEGORIA varchar(200)
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [dbo].[CATEGORIA]
	SET 
	NOMBRE_CATEGORIA = @NOMBRE_CATEGORIA,
	DESCRIPCION_CATEGORIA = @DESCRIPCION_CATEGORIA
	WHERE ID_CATEGORIA = @ID_CATEGORIA
END

CREATE PROCEDURE [dbo].[EditarGasto]
	@IdUsuario int,
	@ID_DINERO int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [dbo].[GASTO]
	SET 
	ID_CATEGORIA = @ID_CATEGORIA,
	IMPORTE_GASTO = @IMPORTE_DINERO,
	DESCRIPCION_GASTO = @DESCRIPCION_DINERO,
	FECHA_GASTO = @FECHA_DINERO
	WHERE ID_GASTO = @ID_DINERO
	AND ID_USUARIO = @IdUsuario
END

CREATE PROCEDURE [dbo].[EditarIngreso]
	@IdUsuario int,
	@ID_DINERO int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime
AS
BEGIN
	SET NOCOUNT ON;
	UPDATE [dbo].[INGRESO]
	SET 
	ID_CATEGORIA = @ID_CATEGORIA,
	IMPORTE_INGRESO = @IMPORTE_DINERO,
	DESCRIPCION_INGRESO = @DESCRIPCION_DINERO,
	FECHA_INGRESO = @FECHA_DINERO
	WHERE ID_INGRESO = @ID_DINERO
	AND ID_USUARIO = @IdUsuario
END

CREATE PROCEDURE [dbo].[GetCategorias]
@idCategoria int = null
AS
BEGIN
SET NOCOUNT ON;
select ID_CATEGORIA AS ID, NOMBRE_CATEGORIA AS NOMBRE, DESCRIPCION_CATEGORIA AS DESCRIPCION, FCREACION_CATEGORIA AS 'FECHA DE CREACIÓN', ESTA_ACTIVA_CATEGORIA AS ACTIVA
from CATEGORIA
where ID_CATEGORIA = @idCategoria or @idCategoria is null
AND ESTA_ACTIVA_CATEGORIA = 1
END

CREATE PROCEDURE [dbo].[GetGastos]
@idUsuario int,
@idDinero int = null
AS
BEGIN
SET NOCOUNT ON;
SELECT g.ID_GASTO AS ID, g.FECHA_GASTO AS FECHA, g.IMPORTE_GASTO AS IMPORTE, g.DESCRIPCION_GASTO AS DESCRIPCION, c.NOMBRE_CATEGORIA AS CATEGORIA, g.ID_CATEGORIA AS ID_CATEGORIA
FROM GASTO g
INNER JOIN CATEGORIA c ON g.ID_CATEGORIA = c.ID_CATEGORIA
WHERE g.ID_GASTO = @idDinero or @idDinero is null
AND g.ID_USUARIO = @idUsuario
AND g.ESTA_ACTIVO_GASTO = 1
AND g.ES_PLAN = 0
ORDER BY g.FECHA_GASTO DESC
END

CREATE PROCEDURE [dbo].[GetIngresos]
@idUsuario int,
@idDinero int = null
AS
BEGIN
SET NOCOUNT ON;
SELECT i.ID_INGRESO AS ID, i.FECHA_INGRESO AS FECHA, i.IMPORTE_INGRESO AS IMPORTE, i.DESCRIPCION_INGRESO AS DESCRIPCION, c.NOMBRE_CATEGORIA AS CATEGORIA, i.ID_CATEGORIA AS ID_CATEGORIA
FROM INGRESO i
INNER JOIN CATEGORIA c ON i.ID_CATEGORIA = c.ID_CATEGORIA
WHERE i.ID_INGRESO = @idDinero or @idDinero is null
AND i.ID_USUARIO = @idUsuario
AND i.ESTA_ACTIVO_INGRESO = 1
AND i.ES_PLAN = 0
ORDER BY i.FECHA_INGRESO DESC
END

CREATE PROCEDURE [dbo].[GetLocalidades]
@idProv int = null
AS
BEGIN
SET NOCOUNT ON;
select * from LOCALIDAD L
where L.ID_PROVINCIA = @idProv or @idProv is null
END


CREATE PROCEDURE [dbo].[GetPlanDinero]
	@idUsuario int,
	@idPlan int
AS
BEGIN
SET NOCOUNT ON;
SELECT g.ID_GASTO AS ID, g.FECHA_GASTO AS FECHA, g.DESCRIPCION_GASTO AS DESCRIPCION, 0 AS INGRESO, g.IMPORTE_GASTO AS GASTO
	FROM PLAN_GASTO gp
	INNER JOIN GASTO g ON gp.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND gp.ID_PLAN = @idPlan
	UNION
	SELECT i.ID_INGRESO AS ID, i.FECHA_INGRESO AS FECHA, i.DESCRIPCION_INGRESO AS DESCRIPCION, i.IMPORTE_INGRESO AS INGRESO, 0 AS GASTO
	FROM PLAN_INGRESO inp
	INNER JOIN INGRESO i ON inp.ID_INGRESO = i.ID_INGRESO
	WHERE i.ESTA_ACTIVO_INGRESO = 1
	AND i.ID_USUARIO = @idUsuario
	AND i.ES_PLAN = 1
	AND inp.ID_PLAN = @idPlan
	UNION
	SELECT 0 AS ID, DATEADD(day,1,GETDATE()) AS FECHA, 'SUBTOTALES' AS DESCRIPCION, (
	SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO inp
	INNER JOIN INGRESO i ON i.ID_INGRESO = inp.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND inp.ID_PLAN = @idPlan
	)  AS INGRESO, (
		SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		) AS GASTO

	UNION
	SELECT 0 AS ID, DATEADD(day,2,GETDATE()) AS FECHA, 'TOTAL' AS DESCRIPCION, (
	SELECT CASE
	WHEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM PLAN_GASTO plg
	INNER JOIN GASTO g ON plg.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND plg.ID_PLAN = @idPlan
	)) > 0
		THEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM PLAN_GASTO plg
	INNER JOIN GASTO g ON plg.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND plg.ID_PLAN = @idPlan
	))
		ELSE 0
	END AS INGRESO
	) AS INGRESO,  (
	SELECT CASE
	WHEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM PLAN_GASTO plg
	INNER JOIN GASTO g ON plg.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND plg.ID_PLAN = @idPlan
	)) < 0
		THEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM PLAN_GASTO plg
	INNER JOIN GASTO g ON plg.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND plg.ID_PLAN = @idPlan
	))
		ELSE 0
	END AS GASTO
	) AS GASTO
	
	ORDER BY FECHA ASC


END


CREATE PROCEDURE [dbo].[GetPlanes]
@idUsuario int,
@idPlan int = null
AS
BEGIN
SET NOCOUNT ON;
SELECT p.ID_PLAN AS ID, p.NOMBRE_PLAN AS NOMBRE, p.DESCRIPCION_PLAN AS DESCRIPCION, p.FECHA_INICIO_PLAN AS 'FECHA INICIO', 
p.FECHA_FIN_PLAN AS 'FECHA FIN', p.CAPITAL_OBJETIVO_PLAN AS CAPITAL
FROM [dbo].[PLAN] p
WHERE p.ID_PLAN = @idPlan or @idPlan is null
AND p.ID_USUARIO = @idUsuario
AND p.ESTA_ACTIVO_PLAN = 1
ORDER BY p.FECHA_INICIO_PLAN DESC
END

CREATE PROCEDURE [dbo].[GetProvincias]
@id int = null

AS
BEGIN
SET NOCOUNT ON;
select * from PROVINCIA p
where (p.ID_PROVINCIA = @id or @id is null)
END

CREATE PROCEDURE [dbo].[GraficoGastosPorCategoria]
	@idUsuario int
AS
BEGIN
SET NOCOUNT ON;
	SELECT c.NOMBRE_CATEGORIA AS CATEGORIA, SUM(g.IMPORTE_GASTO) AS IMPORTE
	FROM GASTO g
	INNER JOIN CATEGORIA c ON c.ID_CATEGORIA = g.ID_CATEGORIA
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 0
	GROUP BY c.NOMBRE_CATEGORIA
END

CREATE PROCEDURE [dbo].[GraficoGastosPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT CAST(FECHA_GASTO AS date) AS FECHA, SUM(IMPORTE_GASTO) AS IMPORTE
	FROM GASTO
	WHERE FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	GROUP BY CAST(FECHA_GASTO AS date)
	ORDER BY FECHA ASC
END

CREATE PROCEDURE [dbo].[GraficoIngresosPorCategoria]
	@idUsuario int
AS
BEGIN
SET NOCOUNT ON;
	SELECT c.NOMBRE_CATEGORIA AS CATEGORIA, SUM(i.IMPORTE_INGRESO) AS IMPORTE
	FROM INGRESO i
	INNER JOIN CATEGORIA c ON c.ID_CATEGORIA = i.ID_CATEGORIA
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	GROUP BY c.NOMBRE_CATEGORIA
END

CREATE PROCEDURE [dbo].[GraficoIngresosPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT CAST(FECHA_INGRESO AS date) AS FECHA, SUM(IMPORTE_INGRESO) AS IMPORTE
	FROM INGRESO
	WHERE FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	GROUP BY CAST(FECHA_INGRESO AS date)
	ORDER BY FECHA ASC
END

CREATE PROCEDURE [dbo].[IniciarSesion]
	--parametros
	@email varchar(100),
	@password varchar(20)
AS
BEGIN
	SET NOCOUNT ON;
	SELECT * FROM USUARIO 
	WHERE EMAIL_USUARIO=@email 
	AND CONTRASENA_USUARIO=@password
	AND ESTA_ACTIVO_USUARIO = 1
END


CREATE PROCEDURE [dbo].[ListadoDineroPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT FECHA_GASTO AS FECHA, DESCRIPCION_GASTO AS DESCRIPCION, 0 AS INGRESO, IMPORTE_GASTO AS GASTO
	FROM GASTO
	WHERE FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	UNION
	SELECT FECHA_INGRESO AS FECHA, DESCRIPCION_INGRESO AS DESCRIPCION, IMPORTE_INGRESO AS INGRESO, 0 AS GASTO
	FROM INGRESO
	WHERE FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	UNION
	SELECT DATEADD(day,1,@fechaFinal) AS FECHA, 'SUBTOTALES' AS DESCRIPCION, (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	)  AS INGRESO, (SELECT SUM(g.IMPORTE_GASTO)
	FROM GASTO g
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 0
	AND  g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	
	) AS GASTO

	UNION
	SELECT DATEADD(day,2,@fechaFinal) AS FECHA, 'TOTAL' AS DESCRIPCION, ((SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	AND i.FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM GASTO g
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 0
	AND  g.FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	
	)
	) AS INGRESO, 0 AS GASTO
	
	ORDER BY FECHA ASC
END


CREATE PROCEDURE [dbo].[ListadoDineroTotal]
	@idUsuario int
AS
BEGIN
SET NOCOUNT ON;
	SELECT FECHA_GASTO AS FECHA, DESCRIPCION_GASTO AS DESCRIPCION, 0 AS INGRESO, IMPORTE_GASTO AS GASTO
	FROM GASTO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	UNION
	SELECT FECHA_INGRESO AS FECHA, DESCRIPCION_INGRESO AS DESCRIPCION, IMPORTE_INGRESO AS INGRESO, 0 AS GASTO
	FROM INGRESO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	UNION
	SELECT DATEADD(day,1,GETDATE()) AS FECHA, 'SUBTOTALES' AS DESCRIPCION, (SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	)  AS INGRESO, (SELECT SUM(g.IMPORTE_GASTO)
	FROM GASTO g
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 0
	) AS GASTO

	UNION
	SELECT DATEADD(day,2,GETDATE()) AS FECHA, 'TOTAL' AS DESCRIPCION, ((SELECT SUM(i.IMPORTE_INGRESO)
	FROM INGRESO i
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 0
	) - (SELECT SUM(g.IMPORTE_GASTO)
	FROM GASTO g
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 0
	)
	) AS INGRESO, 0 AS GASTO
	
	ORDER BY FECHA ASC
END

CREATE PROCEDURE [dbo].[ListadoGastosPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT FECHA_GASTO AS FECHA, IMPORTE_GASTO AS IMPORTE
	FROM GASTO
	WHERE FECHA_GASTO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	ORDER BY FECHA ASC
END

CREATE PROCEDURE [dbo].[ListadoIngresosPorFecha]
	@idUsuario int,
	@fechaInicial Datetime,
	@fechaFinal Datetime
AS
BEGIN
SET NOCOUNT ON;
	SELECT FECHA_INGRESO AS FECHA, IMPORTE_INGRESO AS IMPORTE
	FROM INGRESO
	WHERE FECHA_INGRESO BETWEEN @fechaInicial AND @fechaFinal
	AND ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	ORDER BY FECHA ASC
END

CREATE PROCEDURE [dbo].[RegistrarCategoria]
	@NOMBRE_CATEGORIA varchar(100),
	@DESCRIPCION_CATEGORIA varchar(200),
	@ESTA_ACTIVA_CATEGORIA bit = 1

AS
BEGIN
	SET NOCOUNT ON;
	INSERT INTO [dbo].[CATEGORIA]
	([NOMBRE_CATEGORIA],
	[DESCRIPCION_CATEGORIA],
	[ESTA_ACTIVA_CATEGORIA])
VALUES (
@NOMBRE_CATEGORIA,
@DESCRIPCION_CATEGORIA,
@ESTA_ACTIVA_CATEGORIA)
select SCOPE_IDENTITY()
END


CREATE PROCEDURE [dbo].[RegistrarDomicilio]
	--parametros
	@id_localidad int,
	@calle_domicilio varchar(200),
	@numero_domicilio int
AS
BEGIN
	INSERT INTO DOMICILIO VALUES (@id_localidad, @calle_domicilio, @numero_domicilio)
END


CREATE PROCEDURE [dbo].[RegistrarGasto]
	@ID_USUARIO int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime,
	--@FMOVIMIENTO_DINERO datetime,
	@ESTA_ACTIVO_DINERO bit = 1,
	@ES_PLAN bit = 0

AS
BEGIN
	SET NOCOUNT ON;
	--DECLARE @FECHA_INGRESO datetime
	--SET @FECHA_INGRESO = GETDATE()
	INSERT INTO [dbo].[GASTO]
	([ID_USUARIO],
	[ID_CATEGORIA],
	[IMPORTE_GASTO],
	[DESCRIPCION_GASTO],
	[FECHA_GASTO],
	[ESTA_ACTIVO_GASTO],
	[ES_PLAN])
VALUES (
@ID_USUARIO,
@ID_CATEGORIA,
@IMPORTE_DINERO,
@DESCRIPCION_DINERO,
@FECHA_DINERO,
@ESTA_ACTIVO_DINERO,
@ES_PLAN)
select SCOPE_IDENTITY()
END


CREATE PROCEDURE [dbo].[RegistrarGastoPlan]
	@ID_USUARIO int,
	@ID_PLAN int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime,
	--@FMOVIMIENTO_DINERO datetime,
	@ESTA_ACTIVO_DINERO bit = 1,
	@ES_PLAN bit = 1

AS
BEGIN
	BEGIN TRANSACTION;
	SAVE TRANSACTION SavePoint

	DECLARE @GastoID int;
	--SET NOCOUNT ON;
	--DECLARE @FECHA_INGRESO datetime
	--SET @FECHA_INGRESO = GETDATE()
	BEGIN TRY

	INSERT INTO [dbo].[GASTO]
	([ID_USUARIO],
	[ID_CATEGORIA],
	[IMPORTE_GASTO],
	[DESCRIPCION_GASTO],
	[FECHA_GASTO],
	[ESTA_ACTIVO_GASTO],
	[ES_PLAN])
VALUES (
@ID_USUARIO,
@ID_CATEGORIA,
@IMPORTE_DINERO,
@DESCRIPCION_DINERO,
@FECHA_DINERO,
@ESTA_ACTIVO_DINERO,
@ES_PLAN)
SELECT @GastoID = SCOPE_IDENTITY()
INSERT INTO PLAN_GASTO VALUES (@ID_PLAN, @GastoID) 
COMMIT TRANSACTION
END TRY
BEGIN CATCH
	BEGIN
		ROLLBACK TRANSACTION SavePoint
	END
END CATCH
END

CREATE PROCEDURE [dbo].[RegistrarIngreso]
	@ID_USUARIO int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime,
	--@FMOVIMIENTO_DINERO datetime,
	@ESTA_ACTIVO_DINERO bit = 1,
	@ES_PLAN bit = 0

AS
BEGIN
	SET NOCOUNT ON;
	--DECLARE @FECHA_INGRESO datetime
	--SET @FECHA_INGRESO = GETDATE()
	INSERT INTO [dbo].[INGRESO]
	([ID_USUARIO],
	[ID_CATEGORIA],
	[IMPORTE_INGRESO],
	[DESCRIPCION_INGRESO],
	[FECHA_INGRESO],
	[ESTA_ACTIVO_INGRESO],
	[ES_PLAN])
VALUES (
@ID_USUARIO,
@ID_CATEGORIA,
@IMPORTE_DINERO,
@DESCRIPCION_DINERO,
@FECHA_DINERO,
@ESTA_ACTIVO_DINERO,
@ES_PLAN)
select SCOPE_IDENTITY()
END


CREATE PROCEDURE [dbo].[RegistrarIngresoPlan]
	@ID_USUARIO int,
	@ID_PLAN int,
	@ID_CATEGORIA int,
	@IMPORTE_DINERO decimal(10,2),
	@DESCRIPCION_DINERO varchar(200),
	@FECHA_DINERO datetime,
	--@FMOVIMIENTO_DINERO datetime,
	@ESTA_ACTIVO_DINERO bit = 1,
	@ES_PLAN bit = 1

AS
BEGIN
	BEGIN TRANSACTION;
	SAVE TRANSACTION SavePoint

	DECLARE @IngresoID int;
	--SET NOCOUNT ON;
	--DECLARE @FECHA_INGRESO datetime
	--SET @FECHA_INGRESO = GETDATE()
	BEGIN TRY
	INSERT INTO [dbo].[INGRESO]
	([ID_USUARIO],
	[ID_CATEGORIA],
	[IMPORTE_INGRESO],
	[DESCRIPCION_INGRESO],
	[FECHA_INGRESO],
	[ESTA_ACTIVO_INGRESO],
	[ES_PLAN])
VALUES (
@ID_USUARIO,
@ID_CATEGORIA,
@IMPORTE_DINERO,
@DESCRIPCION_DINERO,
@FECHA_DINERO,
@ESTA_ACTIVO_DINERO,
@ES_PLAN)
SELECT @IngresoID = SCOPE_IDENTITY()
INSERT INTO PLAN_INGRESO VALUES (@ID_PLAN, @IngresoID) 
COMMIT TRANSACTION
END TRY
BEGIN CATCH
	BEGIN
		ROLLBACK TRANSACTION SavePoint
	END
END CATCH
END


CREATE PROCEDURE [dbo].[RegistrarLocalidad]
	--parametros
	@id_provincia int,
	@cod_postal_localidad varchar(5),
	@nombre_localidad varchar(100)
AS
BEGIN
	INSERT INTO LOCALIDAD VALUES (@id_provincia, @cod_postal_localidad, @nombre_localidad)
END

CREATE PROCEDURE [dbo].[RegistrarProvincia]
	--parametros
	@nombre_provincia varchar(100)
AS
BEGIN
	INSERT INTO PROVINCIA VALUES (@nombre_provincia)
END

CREATE PROCEDURE [dbo].[RegistrarUsuario]
@NOMBRE_USUARIO varchar(100),
@APELLIDO_USUARIO varchar(100),
@FNACIMIENTO_PERSONA datetime,
@DNI_USUARIO varchar(10),
@EMAIL_USUARIO varchar(100),
@CONTRASEÑA_USUARIO varchar(20),
@CALLE_DOMICILIO varchar(200),
@NUMERO_DOMICILIO int,
@ID_LOCALIDAD int

AS
BEGIN
SET NOCOUNT ON;
INSERT INTO [dbo].[DOMICILIO]
([ID_LOCALIDAD]
,[CALLE_DOMICILIO]
,[NUMERO_DOMICILIO])

VALUES

(@ID_LOCALIDAD
,@CALLE_DOMICILIO
,@NUMERO_DOMICILIO)
Declare @idUltDomicilio As int = (Select MAX(ID_DOMICILIO) from DOMICILIO)
INSERT INTO [dbo].[USUARIO]
([ID_DOMICILIO]
,[NOMBRES_USUARIO]
,[APELLIDOS_USUARIO]
,[FNACIMIENTO_PERSONA]
,[DNI_USUARIO]
,[EMAIL_USUARIO]
,[CONTRASENA_USUARIO])
VALUES
(@idUltDomicilio

,@NOMBRE_USUARIO
,@APELLIDO_USUARIO
,@FNACIMIENTO_PERSONA
,@DNI_USUARIO
,@EMAIL_USUARIO
,@CONTRASEÑA_USUARIO)
END


CREATE PROCEDURE [dbo].[TotalGastos]
	@idUsuario int
AS
BEGIN
	SELECT ID_USUARIO, COUNT(ID_GASTO) AS GASTOS, SUM(IMPORTE_GASTO) AS IMPORTE
	FROM GASTO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO
END

CREATE PROCEDURE [dbo].[TotalIngresos]
	@idUsuario int
AS
BEGIN
	SELECT ID_USUARIO, COUNT(ID_INGRESO) AS INGRESOS, SUM(IMPORTE_INGRESO) AS IMPORTE
	FROM INGRESO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO
END


CREATE PROCEDURE [dbo].[UltimaFecha]
	@idUsuario int
AS
BEGIN
	SELECT CASE WHEN (
	SELECT ISNULL((SELECT MAX(CAST(FECHA_GASTO AS date)) FROM GASTO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO), NULL) AS ULTIMA_FECHA) 
	> (
	SELECT ISNULL((SELECT MAX(CAST(FECHA_INGRESO AS date)) FROM INGRESO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO), NULL) AS ULTIMA_FECHA) 
	THEN (
	SELECT ISNULL((SELECT MAX(CAST(FECHA_GASTO AS date)) FROM GASTO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_GASTO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO), NULL) AS ULTIMA_FECHA) 
	ELSE (
	SELECT ISNULL((SELECT MAX(CAST(FECHA_INGRESO AS date)) FROM INGRESO
	WHERE ID_USUARIO = @idUsuario
	AND ESTA_ACTIVO_INGRESO = 1
	AND ES_PLAN = 0
	GROUP BY ID_USUARIO), NULL) AS ULTIMA_FECHA)
END AS ULTIMA_FECHA
END

