CREATE PROCEDURE [dbo].[GetPlanDinero]
	@idUsuario int,
	@idPlan int
AS
BEGIN
SET NOCOUNT ON;
SELECT g.ID_GASTO AS ID, g.FECHA_GASTO AS FECHA, g.DESCRIPCION_GASTO AS DESCRIPCION, 0 AS INGRESO, g.IMPORTE_GASTO AS GASTO
	FROM PLAN_GASTO gp
	INNER JOIN GASTO g ON gp.ID_GASTO = g.ID_GASTO
	WHERE g.ID_USUARIO = @idUsuario
	AND g.ESTA_ACTIVO_GASTO = 1
	AND g.ES_PLAN = 1
	AND gp.ID_PLAN = @idPlan
	UNION
	SELECT i.ID_INGRESO AS ID, i.FECHA_INGRESO AS FECHA, i.DESCRIPCION_INGRESO AS DESCRIPCION, i.IMPORTE_INGRESO AS INGRESO, 0 AS GASTO
	FROM PLAN_INGRESO inp
	INNER JOIN INGRESO i ON inp.ID_INGRESO = i.ID_INGRESO
	WHERE i.ESTA_ACTIVO_INGRESO = 1
	AND i.ID_USUARIO = @idUsuario
	AND i.ES_PLAN = 1
	AND inp.ID_PLAN = @idPlan
	UNION
	SELECT 0 AS ID, DATEADD(day,1,GETDATE()) AS FECHA, 'SUBTOTALES' AS DESCRIPCION, (
	SELECT CASE
	WHEN(
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO inp
	INNER JOIN INGRESO i ON i.ID_INGRESO = inp.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND inp.ID_PLAN = @idPlan
	)) < 0 
	THEN 0
	ELSE (SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO inp
	INNER JOIN INGRESO i ON i.ID_INGRESO = inp.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND inp.ID_PLAN = @idPlan
	)
	END
	AS INGRESO), 
	
	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		))
		ELSE 0
		 END AS GASTO
	)

	UNION
	SELECT 0 AS ID, DATEADD(day,2,GETDATE()) AS FECHA, 'TOTAL' AS DESCRIPCION, (
	SELECT CASE
	WHEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		))
		 ELSE 0
		 END
	)
	
	) > 0
		THEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		))
		 ELSE 0
		 END
	))
		ELSE 0
	END AS INGRESO
	) AS INGRESO,  (
	SELECT CASE
	WHEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		))
		 ELSE 0
		 END
	)) < 0
		THEN (
	(SELECT SUM(i.IMPORTE_INGRESO)
	FROM PLAN_INGRESO pli
	INNER JOIN INGRESO i ON pli.ID_INGRESO = i.ID_INGRESO
	WHERE i.ID_USUARIO = @idUsuario
	AND i.ESTA_ACTIVO_INGRESO = 1
	AND i.ES_PLAN = 1
	AND pli.ID_PLAN = @idPlan
	) - 	(
	SELECT CASE 
	WHEN (
(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan )
		) > 0 
		THEN (
		(SELECT SUM(g.IMPORTE_GASTO)
		FROM PLAN_GASTO pg
		INNER JOIN GASTO g ON g.ID_GASTO = pg.ID_GASTO
		WHERE g.ID_USUARIO = @idUsuario
		AND g.ESTA_ACTIVO_GASTO = 1
		AND g.ES_PLAN = 1
		AND pg.ID_PLAN = @idPlan
		))
		 ELSE 0
		 END
	))
		ELSE 0
	END AS GASTO
	) AS GASTO
	
	ORDER BY FECHA ASC


END